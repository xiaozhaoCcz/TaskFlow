# 画布组件拖拽功能实现说明

## 功能概述

现在画布中的组件支持完整的拖拽功能，可以将组件拖拽到任何位置，包括 if/while/foreach/try 等容器组件中。

## 已实现的功能

### 1. 组件可拖拽
- ✅ 画布中的所有任务组件都可以被拖拽
- ✅ 拖拽时组件会显示半透明效果
- ✅ 鼠标光标会变为移动图标

### 2. 拖拽到容器组件
- ✅ 可以将任务拖拽到 **IF** 组件的 THEN 分支
- ✅ 可以将任务拖拽到 **IF** 组件的 ELSE 分支
- ✅ 可以将任务拖拽到 **While** 循环体
- ✅ 可以将任务拖拽到 **Foreach** 循环体
- ✅ 可以将任务拖拽到 **Try** 主体
- ✅ 可以将任务拖拽到 **Try** 的 CATCH 分支

### 3. 拖拽到顶层
- ✅ 可以将嵌套的任务拖拽到顶层画布
- ✅ 可以在顶层任务之间重新排序

### 4. 视觉反馈
- ✅ 拖拽时源组件显示半透明效果（opacity: 0.4）
- ✅ 目标区域悬停时显示蓝色虚线边框
- ✅ 容器为空时显示"拖拽任务到这里"提示
- ✅ 鼠标显示正确的拖拽图标（move/copy）

### 5. 区分新建和移动
- ✅ 从左侧面板拖拽：**复制**创建新任务
- ✅ 从画布拖拽：**移动**现有任务
- ✅ 系统自动从原位置删除，添加到新位置

## 使用方法

### 基本拖拽
1. 将鼠标悬停在任何任务组件的标题栏上
2. 按住鼠标左键开始拖拽
3. 将任务拖到目标位置
4. 释放鼠标完成拖拽

### 拖拽到容器
1. 展开容器组件（如 IF、While、Try）
2. 拖拽任务到相应的分支区域（THEN/ELSE/循环体/CATCH）
3. 当看到蓝色虚线边框时释放鼠标

### 拖拽到顶层
1. 拖拽嵌套在容器中的任务
2. 将其拖到画布的空白区域
3. 释放鼠标，任务会添加到顶层末尾

## 技术实现

### 组件改动

#### 1. TaskBlock.vue
- 添加 `draggable="true"` 属性
- 实现 `handleDragStart` 和 `handleDragEnd` 事件
- 设置拖拽数据，包含 `isCanvasTask` 标记和任务信息
- 添加拖拽状态样式

#### 2. WorkflowBuilder.vue
- 添加全局 `draggingTaskId` 状态管理
- 实现 `moveTask` 方法：移动任务到新位置
- 实现 `removeTask` 方法：从任意位置删除任务
- 通过 provide 向子组件提供全局方法

#### 3. DropZone.vue
- 更新 `handleDrop` 以支持画布任务
- 区分新建任务和移动任务
- 添加拖拽开始/结束事件处理

#### 4. TaskCanvas.vue
- 支持顶层任务的拖拽
- 更新拖放处理逻辑
- 添加拖拽状态传播

### 数据流
```
用户拖拽任务
    ↓
TaskBlock.handleDragStart
    ↓
设置拖拽数据 {isCanvasTask: true, taskId}
    ↓
更新全局 draggingTaskId
    ↓
用户释放到目标位置
    ↓
DropZone/TaskCanvas.handleDrop
    ↓
调用 moveTask(taskId, parentId, branch)
    ↓
removeTask: 从原位置删除
    ↓
在新位置插入任务
    ↓
更新任务树
```

## 保留的原有功能

- ✅ 上移/下移按钮仍然可用
- ✅ 删除按钮功能正常
- ✅ 展开/收起功能不受影响
- ✅ 配置编辑功能正常

## 优势

1. **更直观**：直接拖拽比点击上下按钮更符合用户习惯
2. **更高效**：可以跨层级移动，不需要多次点击
3. **更灵活**：可以随意调整任务结构
4. **保持兼容**：原有的上下移动功能仍然保留

## 注意事项

- 拖拽时会自动从原位置删除任务
- 如果误操作，可以使用撤销功能（如果实现）
- 容器组件需要展开才能看到内部的拖放区域
